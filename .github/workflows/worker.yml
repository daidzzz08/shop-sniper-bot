name: Shop Sniper Worker

on:
  schedule:
    - cron: '0 */6 * * *' # Ch·∫°y m·ªói 6 ti·∫øng (00:00, 06:00, 12:00, 18:00 UTC)
  workflow_dispatch: # Cho ph√©p b·∫•m n√∫t ch·∫°y th·ªß c√¥ng ƒë·ªÉ test

permissions:
  contents: write # C·∫•p quy·ªÅn ghi ƒë·ªÉ l∆∞u file json

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 355 # Gi·ªõi h·∫°n job t·ªëi ƒëa 355 ph√∫t (g·∫ßn 6h)

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Run Bot (5h50m Timeout)
      continue-on-error: true # Quan tr·ªçng: ƒê·ªÉ l·ªói timeout kh√¥ng l√†m d·ª´ng workflow ngay l·∫≠p t·ª©c
      timeout-minutes: 350 # Ch·∫°y code trong 350 ph√∫t r·ªìi t·ª± ng·∫Øt
      env:
        SHOP_DOMAIN: ${{ secrets.SHOP_DOMAIN }}
        SHOP_USER: ${{ secrets.SHOP_USER }}
        SHOP_PASS: ${{ secrets.SHOP_PASS }}
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        OWNER_ID: ${{ secrets.OWNER_ID }}
      run: python bot.py

    - name: Commit Database (Auto-save)
      if: always() # Lu√¥n ch·∫°y b∆∞·ªõc n√†y k·ªÉ c·∫£ khi bot b·ªã timeout
      run: |
        git config --global user.name 'Sniper Bot'
        git config --global user.email 'bot@actions.github.com'
        git add watchlist.json
        # Ch·ªâ commit n·∫øu c√≥ thay ƒë·ªïi
        git diff --quiet && git diff --staged --quiet || (git commit -m "üíæ Auto-save watchlist [skip ci]" && git push)